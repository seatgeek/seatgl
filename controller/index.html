<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Language" content="en" />
</head>
<body>

<style type="text/css">
.controller {
  width: 640px
}
</style>

<div class="controller">
  
</div>

<script src="/vendor/stats.js"></script>
<script src="/vendor/underscore.js"></script>
<script src="/vendor/zepto.js"></script>
<script>

function Controller (domElement) {
  this.currentOrientation = null;
  this.previousOrientation = null;
  this.currentMotion = null;
  this.previousMotion = null;
  this.domElement = domElement;
}

Controller.prototype.initialize = function () {
  window.addEventListener("devicemotion", _.bind(this._handleMotion, this), true);
  window.addEventListener("deviceorientation", _.bind(this._handleOrientation, this), true);

  this.debug = document.createElement("div");
  this.debug.style.cssText = "";
  this.domElement.appendChild(this.debug);

  this._initStats();
  this._startLoop();
  this._openConnection();
};

// IIR filter: http://stackoverflow.com/questions/2272527/how-do-you-use-a-moving-average-to-filter-out-accelerometer-values-in-iphone-os
//   xf = k * xf + (1.0 - k) * x;
//   yf = k * yf + (1.0 - k) * y;

Controller.prototype._handleMotion = function (evt) {
  this.previousMotion = this.currentMotion;
  this.currentMotion = {
    // x: west to east, y: south to north, z: down to up
    acceleration: evt.acceleration,
    rotationRate: evt.rotationRate,
    interval: evt.interval
  };

  // Smoothing
  if (this.previousMotion) {
    var k = 0.25;
    this.currentMotion.acceleration.x = k * this.previousMotion.acceleration.x + (1.0 - k) * this.currentMotion.acceleration.x;
    this.currentMotion.acceleration.y = k * this.previousMotion.acceleration.y + (1.0 - k) * this.currentMotion.acceleration.y;
    this.currentMotion.acceleration.z = k * this.previousMotion.acceleration.z + (1.0 - k) * this.currentMotion.acceleration.z;
  }
};

Controller.prototype._handleOrientation = function (evt) {
  this.previousOrientation = this.currentOrientation;
  this.currentOrientation = {
    // yaw
    alpha: evt.alpha,
    // pitch
    beta: evt.beta,
    // roll
    gamma: evt.gamma
  };

  if (this.previousOrientation) {
    var k = 0.5;
    this.currentOrientation.alpha = k * this.previousOrientation.alpha + (1.0 - k) * this.currentOrientation.alpha;
    this.currentOrientation.beta = k * this.previousOrientation.beta + (1.0 - k) * this.currentOrientation.beta;
    this.currentOrientation.gamma = k * this.previousOrientation.gamma + (1.0 - k) * this.currentOrientation.gamma;
  }
};

Controller.prototype._startLoop = function () {
  var that = this;
  function render() {
  	webkitRequestAnimationFrame(render);
    if (that.stats) {
      that.stats.update();
    }
    if (that.currentMotion && that.currentOrientation) {
      var pre = 2;
      that.debug.innerHTML = "acc: " + that.currentMotion.acceleration.x.toFixed(pre) + ", " + that.currentMotion.acceleration.y.toFixed(pre) + ", " + that.currentMotion.acceleration.z.toFixed(pre) +
                             "<br>" +
                             "rot: " + that.currentMotion.rotationRate.alpha.toFixed(pre) + ", " + that.currentMotion.rotationRate.beta.toFixed(pre) + ", " + that.currentMotion.rotationRate.gamma.toFixed(pre) +
                             "<br>" +
                             "int: " + that.currentMotion.interval.toFixed(pre) +
                             "<br>" +
                             "alp: " + that.currentOrientation.alpha.toFixed(pre) + " | " +
                             "bet: " + that.currentOrientation.beta.toFixed(pre) + " | " +
                             "gam: " + that.currentOrientation.gamma.toFixed(pre);
    }
  }
  render();
};

Controller.prototype._openConnection = function () {
  this.socket = new WebSocket("ws://localhost:5000/api");
  this.socket.onmessage = _.bind(this._onMessage, this);
};

Controller.prototype._pushUpdate = function () {
  this.socket.send(JSON.stringify({
    data: {
      orientation: this.currentOrientation,
      motion: this.currentMotion
    }
  }));
};

Controller.prototype._onMessage = function (msg) {
  console.log(msg);
};

Controller.prototype._initStats = function () {
  this.stats = new Stats();
  // 0: fps, 1: ms
  this.stats.setMode(0);
  this.stats.domElement.style.cssText = 'position: absolute; right: 0; top: 0';
  document.body.appendChild(this.stats.domElement);
};

</script>

<script>

var controller = new Controller($(".controller")[0]);
controller.initialize();

</script>

</body>
</html>
